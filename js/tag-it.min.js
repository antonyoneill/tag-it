(function(b){b.widget("ui.tagit",{options:{allowDuplicates:!1,caseSensitive:!0,fieldName:"tags",placeholderText:null,readOnly:!1,removeConfirmation:!1,tagLimit:null,availableTags:[],autocomplete:{},showAutocompleteOnFocus:!1,allowSpaces:!1,singleField:!1,singleFieldDelimiter:",",singleFieldNode:null,animate:!0,tabIndex:null,beforeTagAdded:null,afterTagAdded:null,beforeTagRemoved:null,afterTagRemoved:null,onTagClicked:null,onTagLimitExceeded:null,onTagAdded:null,onTagRemoved:null,tagSource:null},setPlaceholderText:function(a,
d){a!==this.tagInput.attr("placeholder")&&(b(this).attr("size",a.length),this.options.animate&&d?this.tagInput.animate({placeholder:a,size:a.length}):this.tagInput.attr({placeholder:a,size:a.length}))},setInputDisabled:function(a){a?this.tagInput.attr("disabled",""):this.tagInput.removeAttr("disabled")},_create:function(){var a=this;this.element.is("input")?(this.tagList=b("<ul></ul>").insertAfter(this.element),this.options.singleField=!0,this.options.singleFieldNode=this.element,this.element.addClass("tagit-hidden-field")):
this.tagList=this.element.find("ul, ol").andSelf().last();this.tagInput=b('<input type="text" />').addClass("ui-widget-content");this.options.readOnly&&this.tagInput.attr("disabled","disabled");this.options.tabIndex&&this.tagInput.attr("tabindex",this.options.tabIndex);this.options.placeholderText&&this.tagInput.attr("placeholder",this.options.placeholderText);this.options.autocomplete.source||(this.options.autocomplete.source=function(a,c){var e=a.term.toLowerCase(),d=b.grep(this.options.availableTags,
function(a){return 0===a.toLowerCase().indexOf(e)});this.options.allowDuplicates||(d=this._subtractArray(d,this.assignedTags()));c(d)});this.options.showAutocompleteOnFocus&&(this.tagInput.focus(function(b,d){a._showAutocomplete()}),"undefined"===typeof this.options.autocomplete.minLength&&(this.options.autocomplete.minLength=0));b.isFunction(this.options.autocomplete.source)&&(this.options.autocomplete.source=b.proxy(this.options.autocomplete.source,this));b.isFunction(this.options.tagSource)&&(this.options.tagSource=
b.proxy(this.options.tagSource,this));this.tagList.addClass("tagit").addClass("ui-widget ui-widget-content ui-corner-all").append(b('<li class="tagit-new"></li>').append(this.tagInput)).click(function(d){var c=b(d.target);c.hasClass("tagit-label")?(c=c.closest(".tagit-choice"),c.hasClass("removed")||a._trigger("onTagClicked",d,{tag:c,tagLabel:a.tagLabel(c)})):a.tagInput.focus()});var d=!1;if(this.options.singleField)if(this.options.singleFieldNode){var c=b(this.options.singleFieldNode),g=c.val().split(this.options.singleFieldDelimiter);
c.val("");b.each(g,function(b,c){a.createTag(c,null,!0);d=!0})}else this.options.singleFieldNode=b('<input type="hidden" style="display:none;" value="" name="'+this.options.fieldName+'" />'),this.tagList.after(this.options.singleFieldNode);d||this.tagList.children("li").each(function(){b(this).hasClass("tagit-new")||(a.createTag(b(this).text(),b(this).attr("class"),!0),b(this).remove())});c=function(c){return function(d){var e=d.keyCode||d.which;if(!c){var f=this.value;if(0==e||229==e)switch(f.charCodeAt(f.length-
1)){case 44:e=b.ui.keyCode.COMMA;break;case 32:e=b.ui.keyCode.SPACE}}var f=e===b.ui.keyCode.COMMA&&!1===d.shiftKey,g=e===b.ui.keyCode.ENTER,k=e===b.ui.keyCode.TAB&&""!==a.tagInput.val(),l=e===b.ui.keyCode.SPACE,m=!0!==a.options.allowSpaces,h=b.trim(a.tagInput.val());if(f||g||k||l&&m&&('"'!=h.replace(/^s*/,"").charAt(0)||'"'==h.charAt(0)&&'"'==h.charAt(h.length-1)&&0!==h.length-1))c&&e===b.ui.keyCode.ENTER&&""!==a.tagInput.val()&&d.preventDefault(),!c&&f&&a.tagInput.val(h.substring(0,h.length-1)),
a.options.autocomplete.autoFocus&&a.tagInput.data("autocomplete-open")||(a.tagInput.autocomplete("close"),a.createTag(a._cleanedInput()))}};navigator.userAgent.match(/Android|iPad/i)?(this.tagInput.keyup(c(!1)),this.tagInput.keydown(function(c){(c.keyCode||c.which)===b.ui.keyCode.ENTER&&""!==a.tagInput.val()&&c.preventDefault()})):this.tagInput.keydown(c(!0));this.tagInput.keydown(function(c){c.which==b.ui.keyCode.BACKSPACE&&""===a.tagInput.val()?(c=a._lastTag(),!a.options.removeConfirmation||c.hasClass("remove")?
a.removeTag(c):a.options.removeConfirmation&&c.addClass("remove ui-state-highlight")):a.options.removeConfirmation&&a._lastTag().removeClass("remove ui-state-highlight")});this.tagInput.blur(function(c){a.tagInput.data("autocomplete-open")||a.createTag(a._cleanedInput())});if(this.options.availableTags||this.options.tagSource||this.options.autocomplete.source)c={select:function(c,b){a.createTag(b.item.value);return!1}},b.extend(c,this.options.autocomplete),c.source=this.options.tagSource||c.source,
this.tagInput.autocomplete(c).bind("autocompleteopen.tagit",function(c,b){a.tagInput.data("autocomplete-open",!0)}).bind("autocompleteclose.tagit",function(c,b){a.tagInput.data("autocomplete-open",!1)}),this.tagInput.autocomplete("widget").addClass("tagit-autocomplete")},destroy:function(){b.Widget.prototype.destroy.call(this);this.element.unbind(".tagit");this.tagList.unbind(".tagit");this.tagInput.removeData("autocomplete-open");this.tagList.removeClass("tagit ui-widget ui-widget-content ui-corner-all tagit-hidden-field");
this.element.is("input")?(this.element.removeClass("tagit-hidden-field"),this.tagList.remove()):(this.element.children("li").each(function(){b(this).hasClass("tagit-new")?b(this).remove():(b(this).removeClass("tagit-choice ui-widget-content ui-state-default ui-state-highlight ui-corner-all remove tagit-choice-editable tagit-choice-read-only"),b(this).text(b(this).children(".tagit-label").text()))}),this.singleFieldNode&&this.singleFieldNode.remove());return this},_cleanedInput:function(){return b.trim(this.tagInput.val().replace(/^"(.*)"$/,
"$1"))},_lastTag:function(){return this.tagList.find(".tagit-choice:last:not(.removed)")},_tags:function(){return this.tagList.find(".tagit-choice:not(.removed)")},assignedTags:function(){var a=this,d=[];this.options.singleField?(d=b(this.options.singleFieldNode).val().split(this.options.singleFieldDelimiter),""===d[0]&&(d=[])):this._tags().each(function(){d.push(a.tagLabel(this))});return d},_updateSingleTagsField:function(a){b(this.options.singleFieldNode).val(a.join(this.options.singleFieldDelimiter)).trigger("change")},
_subtractArray:function(a,d){for(var c=[],g=0;g<a.length;g++)-1==b.inArray(a[g],d)&&c.push(a[g]);return c},tagLabel:function(a){return this.options.singleField?b(a).find(".tagit-label:first").text():b(a).find("input:first").val()},_showAutocomplete:function(){this.tagInput.autocomplete("search","")},_findTagByLabel:function(a){var d=this,c=null;this._tags().each(function(g){if(d._formatStr(a)==d._formatStr(d.tagLabel(this)))return c=b(this),!1});return c},_isNew:function(a){return!this._findTagByLabel(a)},
_formatStr:function(a){return this.options.caseSensitive?a:b.trim(a.toLowerCase())},_effectExists:function(a){return!(!b.effects||!(b.effects[a]||b.effects.effect&&b.effects.effect[a]))},createTag:function(a,d,c){var g=this;a=b.trim(a);this.options.preprocessTag&&(a=this.options.preprocessTag(a));if(""===a)return!1;if(!this.options.allowDuplicates&&!this._isNew(a))return a=this._findTagByLabel(a),!1!==this._trigger("onTagExists",null,{existingTag:a,duringInitialization:c})&&this._effectExists("highlight")&&
a.effect("highlight"),!1;if(this.options.tagLimit&&this._tags().length>=this.options.tagLimit)return this._trigger("onTagLimitExceeded",null,{duringInitialization:c}),!1;var e=b(this.options.onTagClicked?'<a class="tagit-label"></a>':'<span class="tagit-label"></span>').text(a),f=b("<li></li>").addClass("tagit-choice ui-widget-content ui-state-default ui-corner-all").addClass(d).append(e);this.options.readOnly?f.addClass("tagit-choice-read-only"):(f.addClass("tagit-choice-editable"),d=b("<span></span>").addClass("ui-icon ui-icon-close"),
d=b('<a><span class="text-icon">\u00d7</span></a>').addClass("tagit-close").append(d).click(function(a){g.removeTag(f)}),f.append(d));this.options.singleField||(e=e.html(),f.append('<input type="hidden" value="'+e+'" name="'+this.options.fieldName+'" class="tagit-hidden-field" />'));!1!==this._trigger("beforeTagAdded",null,{tag:f,tagLabel:this.tagLabel(f),duringInitialization:c,countOfTags:this._tags().length,tagInstance:this})&&(this.options.singleField&&(e=this.assignedTags(),e.push(a),this._updateSingleTagsField(e)),
this._trigger("onTagAdded",null,f),this.tagInput.val(""),this.tagInput.parent().before(f),this._trigger("afterTagAdded",null,{tag:f,tagLabel:this.tagLabel(f),duringInitialization:c,countOfTags:this._tags().length,tagInstance:this}),this.options.showAutocompleteOnFocus&&!c&&setTimeout(function(){g._showAutocomplete()},0))},removeTag:function(a,d){d="undefined"===typeof d?this.options.animate:d;a=b(a);this._trigger("onTagRemoved",null,a);if(!1!==this._trigger("beforeTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a),
countOfTags:this._tags().length,tagInstance:this})){if(this.options.singleField){var c=this.assignedTags(),g=this.tagLabel(a),c=b.grep(c,function(a){return a!=g});this._updateSingleTagsField(c)}if(d){a.addClass("removed");var c=this._effectExists("blind")?["blind",{direction:"horizontal"},"fast"]:["fast"],e=this;c.push(function(){a.remove();e._trigger("afterTagRemoved",null,{tag:a,tagLabel:e.tagLabel(a),countOfTags:e._tags().length,tagInstance:this})});a.fadeOut("fast").hide.apply(a,c).dequeue()}else a.remove(),
this._trigger("afterTagRemoved",null,{tag:a,tagLabel:this.tagLabel(a),countOfTags:this._tags().length,tagInstance:this})}},scrollToBottom:function(){var a=this;setTimeout(function(){var b=a.tagInput.parent().parent();a.options.animate?b.animate({scrollTop:1E4},"slow"):b.scrollTop(1E4)})},removeTagByLabel:function(a,b){var c=this._findTagByLabel(a);if(!c)throw"No such tag exists with the name '"+a+"'";this.removeTag(c,b)},removeAll:function(){var a=this;this._tags().each(function(b,c){a.removeTag(c,
!1)})}})})(jQuery);
